---
status: publish
published: true
pubDatetime: 2013-10-13T20:00:00.000Z
title: Creating a Compound NULLIF in AVG Function With SqlServer
author:
  display_name: Peter Kellner
  login: admin
  email: peter@peterkellner.net
  url: ''
author_login: admin
author_email: peter@peterkellner.net
wordpress_id: 3749
wordpress_url: https://peterkellner.net/?p=3749
date: '2013-10-13 09:33:47 -0700'
date_gmt: '2013-10-13 16:33:47 -0700'
categories:
- SQL Server
- TSQL
- ts
tags: []
---
<p>My use case is I’ve got a session survey column on the <a href="http://www.siliconvalley-codecamp.com/">Silicon Valley Code Camp</a> session evaluation page.&#160; The results of a question like “How is this course overall” can be 0,1,2,3,4,5 where 0 means the person did not answer the question and 5 means the person chose not applicable.&#160; I want to throw away both of these answers in my average using the SqlServer <a href="http://technet.microsoft.com/en-us/library/ms177677.aspx">AVG</a> function (knowing AVG does not include nulls).</p>
<p>With some help from <a href="http://stackoverflow.com/questions/19304951/how-to-get-non-null-non-0-for-average-with-sqlserver-select/19305121#19305121">StackOverflow</a> and some creative nesting, I came up with the following Sql. It feels ugly and not scalable, but it does work.&#160; I’m open to other suggestions but thought I’d post it anyhow as a first pass just to see what others think.&#160; I’m including the full query so it’s clear what I’m going after.&#160; A simple join with a where clause would work if it were just one value I’m selecting.</p>
<div id="codeSnippetWrapper">
<pre id="codeSnippet" style="border-top-style: none; overflow: visible; font-size: 8pt; border-left-style: none; font-family: &#39;Courier New&#39;, courier, monospace; border-bottom-style: none; color: black; padding-bottom: 0px; direction: ltr; text-align: left; padding-top: 0px; border-right-style: none; padding-left: 0px; margin: 0em; line-height: 12pt; padding-right: 0px; width: 100%; background-color: #f4f4f4"><span style="color: #0000ff">SELECT</span> dbo.SessionEvals.SessionId,<br />       <span style="color: #0000ff">AVG</span>(<span style="color: #0000ff">NULLIF</span> (<span style="color: #0000ff">CAST</span> (<span style="color: #0000ff">NULLIF</span> (<span style="color: #0000ff">Cast</span> (dbo.SessionEvals.CourseAsWhole <span style="color: #0000ff">as</span> <span style="color: #0000ff">Float</span>),<br />       5) <span style="color: #0000ff">as</span> <span style="color: #0000ff">Float</span>), 0)) <span style="color: #0000ff">AS</span> CourseAsWholeAvg,<br />       <span style="color: #0000ff">COUNT</span>(*) <span style="color: #0000ff">as</span> CntEvals,<br />       <span style="color: #0000ff">COUNT</span>(<span style="color: #0000ff">case</span><br />               <span style="color: #0000ff">when</span> dbo.SessionEvals.InstructorPromptness = <span style="color: #006080">'On Time'</span> <span style="color: #0000ff">then</span> 1<br />               <span style="color: #0000ff">else</span> <span style="color: #0000ff">null</span><br />             <span style="color: #0000ff">end</span>) <span style="color: #0000ff">AS</span> SpeakerOnTime,<br />       <span style="color: #0000ff">COUNT</span>(<span style="color: #0000ff">case</span><br />               <span style="color: #0000ff">when</span> dbo.SessionEvals.InstructorPromptness = <span style="color: #006080">'Late'</span> <span style="color: #0000ff">then</span> 1<br />               <span style="color: #0000ff">else</span> <span style="color: #0000ff">null</span><br />             <span style="color: #0000ff">end</span>) <span style="color: #0000ff">AS</span> SpeakerLate,<br />       <span style="color: #0000ff">COUNT</span>(<span style="color: #0000ff">case</span><br />               <span style="color: #0000ff">when</span> dbo.SessionEvals.InstructorPromptness = <span style="color: #006080">'No Show'</span> <span style="color: #0000ff">then</span> 1<br />               <span style="color: #0000ff">else</span> <span style="color: #0000ff">null</span><br />             <span style="color: #0000ff">end</span>) <span style="color: #0000ff">AS</span> SpeakerNoShow,<br />       <span style="color: #0000ff">COUNT</span>(<span style="color: #0000ff">case</span><br />               <span style="color: #0000ff">when</span> dbo.SessionEvals.PercentFull = <span style="color: #006080">'10% to 90%'</span> <span style="color: #0000ff">then</span> 1<br />               <span style="color: #0000ff">else</span> <span style="color: #0000ff">null</span><br />             <span style="color: #0000ff">end</span>) <span style="color: #0000ff">AS</span> PercentFull10to90,<br />       <span style="color: #0000ff">COUNT</span>(<span style="color: #0000ff">case</span><br />               <span style="color: #0000ff">when</span> dbo.SessionEvals.PercentFull = <span style="color: #006080">'&gt; 90%'</span> <span style="color: #0000ff">then</span> 1<br />               <span style="color: #0000ff">else</span> <span style="color: #0000ff">null</span><br />             <span style="color: #0000ff">end</span>) <span style="color: #0000ff">AS</span> PercentFullGreaterThan90,<br />       <span style="color: #0000ff">COUNT</span>(<span style="color: #0000ff">case</span><br />               <span style="color: #0000ff">when</span> dbo.SessionEvals.PercentFull = <span style="color: #006080">' &lt; 10% Full '</span> <span style="color: #0000ff">then</span> 1<br />               <span style="color: #0000ff">else</span> <span style="color: #0000ff">null</span><br />             <span style="color: #0000ff">end</span>) <span style="color: #0000ff">AS</span> PercentFullLessThan10,<br />       <span style="color: #0000ff">AVG</span>(<span style="color: #0000ff">NULLIF</span> (<span style="color: #0000ff">Cast</span> (dbo.SessionEvals.EstimatedNumberAttendees <span style="color: #0000ff">as</span> <span style="color: #0000ff">Float</span>), 0)<br />       ) <span style="color: #0000ff">AS</span> EstimatedAttending<br /><span style="color: #0000ff">FROM</span> dbo.Sessions<br />     <span style="color: #0000ff">INNER</span> <span style="color: #0000ff">JOIN</span> dbo.SessionEvals <span style="color: #0000ff">ON</span> (dbo.Sessions.Id =<br />     dbo.SessionEvals.SessionId)<br /><span style="color: #0000ff">WHERE</span> dbo.Sessions.CodeCampYearId = {0} <span style="color: #0000ff">AND</span><br />      <br /><span style="color: #0000ff">GROUP</span> <span style="color: #0000ff">BY</span> dbo.SessionEvals.SessionId</pre>
<p></div></p>
<p>(CourseAsaWhole is all I’m really talking about here)</p>
